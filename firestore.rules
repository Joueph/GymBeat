rules_version = '2';
service cloud.firestore {
match /databases/{database}/documents {

// =================================================================
// Funções de Apoio (Helper Functions)
// =================================================================

function isOwner(userId) {
  return request.auth.uid == userId;
}

function isMutualFriend(userId) {
    let currentUserData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    let otherUserData = get(/databases/$(database)/documents/users/$(userId)).data;
    return (userId in currentUserData.amizades && currentUserData.amizades[userId] == true) &&
           (request.auth.uid in otherUserData.amizades && otherUserData.amizades[request.auth.uid] == true);
}

function hasSentMeRequest(requesterId) {
  let requesterData = get(/databases/$(database)/documents/users/$(requesterId)).data;
  return request.auth.uid in requesterData.amizades && requesterData.amizades[request.auth.uid] == true;
}

// NOVA FUNÇÃO: Verifica se o usuário autenticado é participante de um projeto.
function isProjectParticipant(projetoId) {
  return request.auth.uid in get(/databases/$(database)/documents/projetos/$(projetoId)).data.participantes;
}

// Helper function to check if the user owns the ficha associated with a log.
function isOwnerOfAssociatedFicha(logData) {
  return logData.treino.fichaId != null && isOwner(get(/databases/$(database)/documents/fichas/$(logData.treino.fichaId)).data.usuarioId);
}


// =================================================================
// Regras para a Coleção de Usuários (users)
// =================================================================
match /users/{userId} {
  allow read: if isOwner(userId) || isMutualFriend(userId) || hasSentMeRequest(userId);
  allow write: if isOwner(userId);

  match /publicProfile/{docId} {
    allow read: if 
      get(/databases/$(database)/documents/users/$(userId)).data.profileVisibility == 'todos' ||
      (get(/databases/$(database)/documents/users/$(userId)).data.profileVisibility == 'amigos' && 
       (isOwner(userId) || (userId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.amizades && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.amizades[userId] == true)));

    allow write: if isOwner(userId);
  }
}

// =================================================================
// Regras para a Coleção de Estatísticas de Onboarding
// =================================================================
match /estatisticasOnboarding/{userId} {
  // Permite que um usuário autenticado (anônimo ou permanente) crie, leia e atualize seu próprio documento.
  // A função isOwner(userId) verifica se request.auth.uid === userId.
  allow create, read, update: if isOwner(userId);
  // Impede que o cliente delete o documento.
  allow delete: if false;
}

// =================================================================
// Regras para Coleções de Dados do Usuário (fichas, treinos)
// =================================================================

match /fichas/{fichaId} {
  allow read: if isOwner(resource.data.usuarioId) || isMutualFriend(resource.data.usuarioId);
  allow create: if isOwner(request.resource.data.usuarioId);
  allow update, delete: if isOwner(resource.data.usuarioId);
}

match /treinos/{treinoId} {
  // Permite a leitura se o usuário for o dono do treino, amigo do dono,
  // OU se o usuário for dono da ficha à qual este treino pertence.
  allow read: if isOwner(resource.data.usuarioId) || isMutualFriend(resource.data.usuarioId) || isOwner(get(/databases/$(database)/documents/fichas/$(resource.data.fichaId)).data.usuarioId);
  allow create, delete: if isOwner(request.resource.data.usuarioId) || isOwner(resource.data.usuarioId);
  
  // Allow update if the user owns the workout OR if they are un-assigning it from a workout plan (ficha) they own.
  // This is crucial for the deleteFicha operation, which moves workouts to the "unassigned" folder.
  allow update: if isOwner(resource.data.usuarioId) || 
                   (isOwner(get(/databases/$(database)/documents/fichas/$(resource.data.fichaId)).data.usuarioId) &&
                    request.resource.data.fichaId == null);
}

// =================================================================
// Regras para a Coleção de Logs
// =================================================================
match /logs/{logId} {
  // ATUALIZADO: Permite a leitura se:
  // 1. O usuário for o dono do log.
  // 2. O usuário for amigo do dono do log.
  // 3. O log tiver um 'projetoId' e o usuário for participante desse projeto.
  allow read: if isOwner(resource.data.usuarioId) || (resource.data.projetoId != null && isProjectParticipant(resource.data.projetoId)) ||
                 isOwnerOfAssociatedFicha(resource.data);

  // Permite criar, atualizar e apagar se o usuário for o dono do log.
  // Para 'create', a regra verifica os dados que estão sendo enviados (request.resource.data).
  // Para 'update' e 'delete', a regra verifica os dados já existentes (resource.data).
  allow write: if isOwner(request.resource.data.usuarioId) || isOwner(resource.data.usuarioId);
}

// =================================================================
// Regras para a Coleção de Projetos
// =================================================================
match /projetos/{projetoId} {
  allow read: if request.auth.uid in resource.data.participantes;
  // Permite a um participante adicionar-se ao projeto (update).
  allow update: if request.auth.uid == resource.data.criadorId || 
                   (request.auth.uid in resource.data.participantes && 
                    request.resource.data.participantes.hasAny([request.auth.uid]));
  allow create: if request.auth != null && request.resource.data.criadorId == request.auth.uid;
  allow delete: if request.auth.uid == resource.data.criadorId;
}

// =================================================================
// Regras para Coleções de Modelos (Públicas)
// =================================================================

match /fichasModelos/{fichaModeloId} {
  allow read: if request.auth != null;
  allow write: if false;
}

match /treinosModelos/{treinoModeloId} {
  allow read: if request.auth != null;
  allow write: if false;
}

match /exerciciosModelos/{exercicioModeloId} {
  allow read: if request.auth != null;
  allow create: if isOwner(request.resource.data.userId);
  allow update, delete: if isOwner(resource.data.userId) && resource.data.isCustom == true;
  allow write: if false;
}

// =================================================================
// Regras para a Coleção de Sugestão de Funcionalidades (feature_suggestions)
// =================================================================
match /feature_suggestions/{suggestionId} {
  // Qualquer usuário autenticado pode ler as sugestões.
  allow read: if request.auth != null;

  // Permite que um usuário autenticado crie uma nova sugestão,
  // validando que ele é o criador e que o voto inicial é 1.
  allow create: if request.auth != null
                && request.resource.data.createdBy == request.auth.uid
                && request.resource.data.votes == 1
                && request.resource.data.votedBy[0] == request.auth.uid;

  // Permite que um usuário autenticado atualize uma sugestão (vote),
  // mas apenas se ele ainda não votou.
  // Garante que apenas o campo 'votes' e 'votedBy' sejam alterados.
  allow update: if request.auth != null
                && !(request.auth.uid in resource.data.votedBy)
                && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['votes', 'votedBy']);
}
}
}